# =============================================================================
# OpenMetadata Dependencies Helm Values
# Chart: open-metadata/openmetadata-dependencies
# Inclut: MySQL, OpenSearch, Airflow
# =============================================================================

# -- StorageClass à utiliser pour tous les PVC
# Pas besoin de forcer : local-path est déjà la StorageClass par défaut du cluster.
# Forcer global.storageClass cause des erreurs "Forbidden" sur les StatefulSets existants.
# global:
#   storageClass: local-path

# =============================================================================
# MySQL
# =============================================================================
mysql:
  enabled: true
  fullnameOverride: "mysql"
  image:
    tag: "8.0"
  auth:
    rootPassword: ""  # Défini via secret
    database: openmetadata_db
    username: openmetadata_user
    existingSecret: mysql-secrets
  primary:
    persistence:
      enabled: true
      # storageClass: ""
      size: 5Gi
      accessModes:
        - ReadWriteOnce
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1
        memory: 2Gi
  initdbScripts:
    init_openmetadata_db_scripts.sql: |
      CREATE DATABASE IF NOT EXISTS openmetadata_db;
      CREATE USER IF NOT EXISTS 'openmetadata_user'@'%' IDENTIFIED BY 'openmetadata_password';
      GRANT ALL PRIVILEGES ON openmetadata_db.* TO 'openmetadata_user'@'%';
      FLUSH PRIVILEGES;

# =============================================================================
# OpenSearch
# =============================================================================
opensearch:
  enabled: true
  fullnameOverride: "opensearch"
  clusterName: "opensearch"
  replicas: 1
  minimumMasterNodes: 1
  singleNode: true
  resources:
    requests:
      cpu: 250m
      memory: 1Gi
    limits:
      cpu: 1
      memory: 2Gi
  persistence:
    enabled: true
    # storageClass: ""
    size: 5Gi
    accessModes:
      - ReadWriteOnce
  config:
    opensearch.yml: |
      plugins.security.disabled: true
      discovery.type: single-node
  extraEnvs:
    - name: DISABLE_SECURITY_PLUGIN
      value: "true"

# =============================================================================
# Airflow
# =============================================================================
airflow:
  enabled: true
  airflow:
    image:
      repository: docker.getcollate.io/openmetadata/ingestion
      tag: "1.11.8"
      pullPolicy: Always
    executor: LocalExecutor
    config:
      AIRFLOW__API__AUTH_BACKENDS: "airflow.api.auth.backend.basic_auth,airflow.api.auth.backend.session"
    users:
      - username: admin
        password: admin
        role: Admin
        email: admin@openmetadata.org
        firstName: Admin
        lastName: User
  # -- Disable Helm hooks so ArgoCD manages these Jobs as regular resources
  # Without this, the migration Job is a post-install hook that ArgoCD never triggers
  migrateDatabaseJob:
    useHelmHooks: false
  createUserJob:
    useHelmHooks: false
  # NOTE: This chart deploys Airflow as separate components (apiServer, scheduler,
  # dagProcessor, triggerer). Keep resources low for single-node demo clusters.
  apiServer:
    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi
  scheduler:
    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi
  dagProcessor:
    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi
  triggerer:
    resources:
      requests:
        cpu: 25m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi
  postgresql:
    enabled: true
    image:
      registry: docker.io
      repository: bitnamilegacy/postgresql
      tag: 16.1.0-debian-11-r20
    auth:
      enablePostgresUser: true
      postgresPassword: postgres
      database: airflow
    persistence:
      enabled: true
      # storageClass: ""
      size: 5Gi
      accessModes:
        - ReadWriteOnce
  dags:
    persistence:
      enabled: true
      # storageClass: ""
      size: 1Gi
  logs:
    persistence:
      enabled: false
      # storageClass: ""
      size: 1Gi
