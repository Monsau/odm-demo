# =============================================================================
# OpenMetadata Dependencies Helm Values
# Chart: open-metadata/openmetadata-dependencies
# Inclut: MySQL, OpenSearch, Airflow
# =============================================================================

# -- StorageClass à utiliser pour tous les PVC
# Pas besoin de forcer : local-path est déjà la StorageClass par défaut du cluster.
# Forcer global.storageClass cause des erreurs "Forbidden" sur les StatefulSets existants.
# global:
#   storageClass: local-path

# =============================================================================
# MySQL
# =============================================================================
mysql:
  enabled: true
  fullnameOverride: "mysql"
  image:
    tag: "8.0"
  auth:
    rootPassword: ""  # Défini via secret
    database: openmetadata_db
    username: openmetadata_user
    existingSecret: mysql-secrets
  primary:
    persistence:
      enabled: true
      # storageClass: ""
      size: 5Gi
      accessModes:
        - ReadWriteOnce
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1
        memory: 2Gi
  initdbScripts:
    init_openmetadata_db_scripts.sql: |
      CREATE DATABASE IF NOT EXISTS openmetadata_db;
      CREATE USER IF NOT EXISTS 'openmetadata_user'@'%' IDENTIFIED BY 'openmetadata_password';
      GRANT ALL PRIVILEGES ON openmetadata_db.* TO 'openmetadata_user'@'%';
      FLUSH PRIVILEGES;

# =============================================================================
# OpenSearch
# =============================================================================
opensearch:
  enabled: true
  fullnameOverride: "opensearch"
  clusterName: "opensearch"
  replicas: 1
  minimumMasterNodes: 1
  singleNode: true
  resources:
    requests:
      cpu: 250m
      memory: 1Gi
    limits:
      cpu: 1
      memory: 2Gi
  persistence:
    enabled: true
    # storageClass: ""
    size: 5Gi
    accessModes:
      - ReadWriteOnce
  config:
    opensearch.yml: |
      plugins.security.disabled: true
      discovery.type: single-node
  extraEnvs:
    - name: DISABLE_SECURITY_PLUGIN
      value: "true"

# =============================================================================
# Airflow
# =============================================================================
airflow:
  enabled: true
  airflow:
    image:
      repository: docker.getcollate.io/openmetadata/ingestion
      tag: "1.11.8"
      pullPolicy: Always
    executor: LocalExecutor
    config:
      AIRFLOW__API__AUTH_BACKENDS: "airflow.api.auth.backend.basic_auth,airflow.api.auth.backend.session"
    users:
      - username: admin
        password: admin
        role: Admin
        email: admin@openmetadata.org
        firstName: Admin
        lastName: User
  # -- Static secret key for Airflow webserver (required for JWT token auth)
  webserverSecretKey: "a5f8c3e2d1b9a7f6e4c3b2a1f9e8d7c6b5a4f3e2d1c9b8a7f6e5d4c3b2a1f0e9"
  # -- Workaround for Airflow 3 + MySQL compatibility: downgrade FAB provider
  env:
    - name: _PIP_ADDITIONAL_REQUIREMENTS
      value: "apache-airflow-providers-fab==2.4.4"
  # -- Disable Helm hooks so ArgoCD manages the migration Job as a regular resource
  migrateDatabaseJob:
    useHelmHooks: false
  createUserJob:
    useHelmHooks: false
  # -- Disable waitForMigrations on ALL components to avoid init container deadlock
  # (from working prod config: the migration Job runs independently)
  apiServer:
    waitForMigrations:
      enabled: false
    extraInitContainers: []
    startupProbe:
      timeoutSeconds: 60
      failureThreshold: 30
      periodSeconds: 10
    livenessProbe:
      timeoutSeconds: 60
      failureThreshold: 5
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        cpu: 1
        memory: 2Gi
  scheduler:
    waitForMigrations:
      enabled: false
    extraInitContainers: []
    startupProbe:
      timeoutSeconds: 60
      failureThreshold: 30
      periodSeconds: 10
    livenessProbe:
      timeoutSeconds: 60
      failureThreshold: 5
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        cpu: 1
        memory: 2Gi
  dagProcessor:
    waitForMigrations:
      enabled: false
    extraInitContainers: []
    livenessProbe:
      timeoutSeconds: 60
      failureThreshold: 5
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        cpu: 1
        memory: 2Gi
  triggerer:
    waitForMigrations:
      enabled: false
    extraInitContainers: []
    livenessProbe:
      timeoutSeconds: 60
      failureThreshold: 5
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi
  # -- Flower & Redis not needed with LocalExecutor
  flower:
    enabled: false
  redis:
    enabled: false
  postgresql:
    enabled: true
    image:
      registry: docker.io
      repository: bitnamilegacy/postgresql
      tag: 16.1.0-debian-11-r20
    auth:
      enablePostgresUser: true
      postgresPassword: postgres
      database: airflow
    persistence:
      enabled: true
      size: 5Gi
      accessModes:
        - ReadWriteOnce
  dags:
    persistence:
      enabled: true
      size: 1Gi
      storageClassName: local-path
  logs:
    persistence:
      enabled: false
      size: 1Gi
  ingress:
    apiServer:
      enabled: true
      ingressClassName: traefik
      annotations: {}
      hosts:
        - name: airflow.192.168.11.150.nip.io
          path: /
        - name: airflow.local
          path: /
      tls:
        enabled: false
