# =============================================================================
# OpenMetadata Helm Values
# Chart: open-metadata/openmetadata
# Version: 1.11.8
# Repo: https://helm.open-metadata.org
# =============================================================================

replicaCount: 1

image:
  repository: docker.getcollate.io/openmetadata/server
  pullPolicy: Always
  tag: "1.11.8"

# -- Nom complet du release Helm
fullnameOverride: "openmetadata"

# =============================================================================
# Configuration OpenMetadata
# =============================================================================
openmetadata:
  config:
    # -------------------------------------------------------------------------
    # Authentification
    # -------------------------------------------------------------------------
    authentication:
      enabled: true
      # Keycloak / OIDC (SSO)
      # NOTE:
      # - `provider: custom-oidc` is the recommended setting for Keycloak.
      # - Update the placeholders (realm, hostnames, etc.) to match your Keycloak + Ingress.
      provider: custom-oidc
      # Use `confidential` for Authorization Code flow (client secret required)
      # Use `public` for implicit/public clients (no secret)
      clientType: confidential
      publicKeys:
        - "http://openmetadata:8585/api/v1/system/config/jwks"
        # Keycloak JWKS (certs) endpoint
        # Use the in-cluster service FQDN so OpenMetadata pods don't depend on external DNS.
        - "http://keycloak.auth.svc.cluster.local:8080/realms/tour-operator/protocol/openid-connect/certs"
      # Keycloak Authorization Endpoint (per OM Keycloak SSO guide)
      authority: "http://auth.192.168.11.150.nip.io/realms/tour-operator/protocol/openid-connect/auth"
      # Kept for compatibility (some flows read these). Prefer setting clientId/secret in oidcConfiguration below.
      clientId: ""
      callbackUrl: "http://openmetadata.local/callback"
      responseType: code
      enableSelfSignup: true
      jwtPrincipalClaims:
        - email
        - preferred_username
        - sub

      # OIDC Authorization Code Flow (recommended)
      oidcConfiguration:
        enabled: true
        # Informational label used by OM in some flows; keep `custom` for Keycloak.
        oidcType: "custom"
        clientId:
          secretRef: oidc-secrets
          secretKey: openmetadata-oidc-client-id
        clientSecret:
          secretRef: oidc-secrets
          secretKey: openmetadata-oidc-client-secret
        scope: "openid email profile"
        # Use in-cluster discovery URI so OM can fetch metadata even if `auth.demo.ai` is not resolvable from pods.
        discoveryUri: "http://keycloak.auth.svc.cluster.local:8080/realms/tour-operator/.well-known/openid-configuration"
        useNonce: true
        preferredJwsAlgorithm: RS256
        responseType: code
        promptType: "consent"
        # Leave this as `true` unless you explicitly want PKCE.
        disablePkce: true
        callbackUrl: "http://openmetadata.local/callback"
        serverUrl: "http://openmetadata.local"
        clientAuthenticationMethod: client_secret_post
        tenant: ""
        maxClockSkew: ""
        tokenValidity: "3600"
        customParams: '{}'
        maxAge: "0"
        sessionExpiry: "604800"

    # -------------------------------------------------------------------------
    # Authorizer
    # -------------------------------------------------------------------------
    authorizer:
      enabled: true
      className: org.openmetadata.service.security.DefaultAuthorizer
      containerRequestFilter: org.openmetadata.service.security.JwtFilter
      initialAdmins:
        - admin
        - youssef.elalami
        - fatima.chraibi
      allowedEmailRegistrationDomains:
        - all
      principalDomain: open-metadata.org
      enforcePrincipalDomain: false
      enableSecureSocketConnection: false

    # -------------------------------------------------------------------------
    # Base de donn√©es (MySQL)
    # -------------------------------------------------------------------------
    database:
      enabled: true
      host: mysql
      port: 3306
      databaseName: openmetadata_db
      dbScheme: mysql
      driverClass: com.mysql.cj.jdbc.Driver
      dbParams: "allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=UTC"
      auth:
        username: openmetadata_user
        password:
          secretRef: mysql-secrets
          secretKey: openmetadata-mysql-password

    # -------------------------------------------------------------------------
    # Elasticsearch / OpenSearch
    # -------------------------------------------------------------------------
    elasticsearch:
      enabled: true
      host: opensearch
      port: 9200
      scheme: http
      searchType: opensearch
      clusterAlias: ""
      searchIndexMappingLanguage: EN
      keepAliveTimeoutSecs: 600
      payLoadSize: 10485760
      auth:
        enabled: false
        username: elasticsearch
        password:
          secretRef: elasticsearch-secrets
          secretKey: openmetadata-elasticsearch-password
      trustStore:
        enabled: false

    # -------------------------------------------------------------------------
    # Pipeline Service Client (Airflow)
    # -------------------------------------------------------------------------
    pipelineServiceClientConfig:
      enabled: true
      className: org.openmetadata.service.clients.pipeline.airflow.AirflowRESTClient
      apiEndpoint: http://openmetadata-dependencies-api-server:8080
      metadataApiEndpoint: http://openmetadata:8585/api
      verifySsl: "no-ssl"
      sslCertificatePath: "/no/path"
      healthCheckInterval: 300
      ingestionIpInfoEnabled: false
      auth:
        username: admin
        password:
          secretRef: airflow-secrets
          secretKey: openmetadata-airflow-password

    # -------------------------------------------------------------------------
    # JWT Token Configuration
    # -------------------------------------------------------------------------
    jwtTokenConfiguration:
      enabled: true
      rsapublicKeyFilePath: "./conf/public_key.der"
      rsaprivateKeyFilePath: "./conf/private_key.der"
      jwtissuer: "open-metadata.org"
      keyId: "Gb389a-9f76-gdjs-a92j-0242bk94356"

    # -------------------------------------------------------------------------
    # Fernet Key (chiffrement)
    # -------------------------------------------------------------------------
    fernetkey:
      value: "jJ/9sz0g0OHxsfxOoSfdFdmk3ysNmPRnH3TUAbz3IHA="
      secretRef: ""
      secretKey: ""

    # -------------------------------------------------------------------------
    # Serveur OpenMetadata
    # -------------------------------------------------------------------------
    openmetadata:
      host: "0.0.0.0"
      port: 8585
      adminPort: 8586

    # -------------------------------------------------------------------------
    # Cluster
    # -------------------------------------------------------------------------
    clusterName: openmetadata

    # -------------------------------------------------------------------------
    # Logs
    # -------------------------------------------------------------------------
    logLevel: INFO

    # -------------------------------------------------------------------------
    # Event Monitor
    # -------------------------------------------------------------------------
    eventMonitor:
      enabled: true
      type: prometheus
      batchSize: 10
      pathPattern:
        - "/api/v1/tables/*"
        - "/api/v1/health-check"
      latency: []

    # -------------------------------------------------------------------------
    # Secrets Manager
    # -------------------------------------------------------------------------
    secretsManager:
      enabled: false
      provider: in-memory
      prefix: ""
      tags: []
      additionalParameters:
        enabled: false

    # -------------------------------------------------------------------------
    # Web Configuration
    # -------------------------------------------------------------------------
    web:
      enabled: true
      contentTypeOptions:
        enabled: false
      csp:
        enabled: false
        policy: "default-src 'self'"
        reportOnlyPolicy: ""
      frameOptions:
        enabled: false
        option: SAMEORIGIN
        origin: ""
      hsts:
        enabled: false
        includeSubDomains: "true"
        maxAge: "365 days"
        preload: "true"
      uriPath: "/api"
      xssProtection:
        block: true
        enabled: false
        onXss: true
      referrerPolicy:
        enabled: false
        option: "SAME_ORIGIN"
      permissionPolicy:
        enabled: false
        option: ""

    # -------------------------------------------------------------------------
    # Upgrade Migration
    # -------------------------------------------------------------------------
    upgradeMigrationConfigs:
      debug: false
      additionalArgs: ""

    # -------------------------------------------------------------------------
    # Deploy Pipelines
    # -------------------------------------------------------------------------
    deployPipelinesConfig:
      enabled: true
      debug: false
      additionalArgs: ""

    # -------------------------------------------------------------------------
    # Reindex
    # -------------------------------------------------------------------------
    reindexConfig:
      enabled: true
      debug: false
      additionalArgs: ""

# =============================================================================
# Service Kubernetes
# =============================================================================
service:
  type: ClusterIP
  port: 8585
  adminPort: 8586
  annotations: {}

# =============================================================================
# Ingress
# =============================================================================
ingress:
  # Disabled: custom ingress in k8s/ingress-openmetadata.yaml routes via oauth2-proxy
  enabled: false
  className: traefik
  annotations: {}
  hosts:
    - host: openmetadata.192.168.11.150.nip.io
      paths:
        - path: /
          pathType: Prefix
  tls: []

# =============================================================================
# Resources
# =============================================================================
resources:
  requests:
    cpu: 500m
    memory: 1Gi
  limits:
    cpu: 2
    memory: 4Gi

# =============================================================================
# Probes
# =============================================================================
livenessProbe:
  initialDelaySeconds: 60
  periodSeconds: 30
  failureThreshold: 5
  httpGet:
    path: /healthcheck
    port: http-admin

readinessProbe:
  initialDelaySeconds: 60
  periodSeconds: 30
  failureThreshold: 5
  httpGet:
    path: /
    port: http

startupProbe:
  periodSeconds: 60
  failureThreshold: 5
  successThreshold: 1
  httpGet:
    path: /healthcheck
    port: http-admin

# =============================================================================
# Service Account
# =============================================================================
serviceAccount:
  create: true
  annotations: {}
  name:

automountServiceAccountToken: true

# =============================================================================
# Autres
# =============================================================================
podAnnotations: {}
podSecurityContext: {}
securityContext: {}
nodeSelector: {}
tolerations: []
affinity: {}
commonLabels: {}
extraEnvs: []
extraInitContainers: []
extraVolumes: []
extraVolumeMounts: []
sidecars: []
imagePullSecrets: []

# =============================================================================
# Monitoring
# =============================================================================
serviceMonitor:
  enabled: false
  interval: 30s
  labels: {}
  annotations: {}

# =============================================================================
# Network Policy & PDB
# =============================================================================
networkPolicy:
  enabled: false

podDisruptionBudget:
  enabled: false
  config:
    maxUnavailable: "1"
    minAvailable: "1"
